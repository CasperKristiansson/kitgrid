function handler(event) {
  var request = event.request;
  var headers = request.headers || {};
  var hostHeader = headers.host || headers.Host;
  var host = (hostHeader && hostHeader.value) || '';
  var uri = request.uri || '/';

  var hubHost = "${hub_host}";
  var hubPrefix = "${hub_prefix}";
  var sitesPrefix = "${sites_prefix}";
  var hubHostLower = hubHost.toLowerCase();

  function serializeQueryString(querystring) {
    if (!querystring) {
      return '';
    }
    var pairs = [];
    for (var key in querystring) {
      if (!Object.prototype.hasOwnProperty.call(querystring, key)) {
        continue;
      }
      var entry = querystring[key];
      if (!entry) {
        continue;
      }
      if (entry.multiValue && entry.multiValue.length > 0) {
        for (var i = 0; i < entry.multiValue.length; i++) {
          var multi = entry.multiValue[i];
          if (multi && typeof multi.value === 'string') {
            pairs.push(encodeURIComponent(key) + '=' + encodeURIComponent(multi.value));
          }
        }
        continue;
      }
      if (typeof entry.value === 'string') {
        if (entry.value === '') {
          pairs.push(encodeURIComponent(key));
        } else {
          pairs.push(encodeURIComponent(key) + '=' + encodeURIComponent(entry.value));
        }
      }
    }
    if (pairs.length === 0) {
      return '';
    }
    return '?' + pairs.join('&');
  }

  function buildRedirectResponse(targetHost) {
    var location = 'https://' + targetHost + uri + serializeQueryString(request.querystring);
    return {
      statusCode: 301,
      statusDescription: 'Moved Permanently',
      headers: {
        location: {
          value: location
        }
      }
    };
  }

  function needsIndexSuffix(path) {
    if (!path || path === '/' || path.endsWith('/')) {
      return true;
    }
    var lastSlash = path.lastIndexOf('/');
    var lastSegment = path.slice(lastSlash + 1);
    return lastSegment.indexOf('.') === -1;
  }

  function buildPath(basePath, originalPath) {
    var base = basePath.endsWith('/') ? basePath.slice(0, -1) : basePath;
    var suffix = originalPath && originalPath.length > 0 ? originalPath : '/';
    if (!suffix.startsWith('/')) {
      suffix = '/' + suffix;
    }
    var resolved = base + suffix;
    if (needsIndexSuffix(suffix)) {
      resolved += resolved.endsWith('/') ? 'index.html' : '/index.html';
    }
    return resolved;
  }

  var normalizedHost = host.toLowerCase();
  if (normalizedHost.startsWith('www.') && host.length > 4) {
    return buildRedirectResponse(host.slice(4));
  }

  if (host === '' || normalizedHost === hubHostLower) {
    request.uri = buildPath(hubPrefix, uri);
    return request;
  }

  var projectId = normalizedHost.split('.')[0];
  var projectBase = sitesPrefix + '/' + projectId + '/current';
  request.uri = buildPath(projectBase, uri);
  return request;
}
