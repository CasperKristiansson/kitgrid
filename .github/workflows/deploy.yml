name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
  repository_dispatch:
    types: [build-docs]

env:
  PNPM_VERSION: 8.15.4
  NODE_VERSION: 20.11.1
  KITGRID_SITE_BUCKET: kitgrid-sites
  PROJECT_ID: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.project || '' }}
  PROJECT_REF: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.ref || 'main' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Fetch project docs
        if: ${{ env.PROJECT_ID != '' }}
        run: pnpm docs:fetch -- --project "${PROJECT_ID}" --ref "${PROJECT_REF}"

      - name: Build sites
        run: pnpm build:sites

      - name: Stage artifacts
        run: pnpm package:sites

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.KITGRID_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Sync hub
        run: aws s3 sync .kitgrid-cache/deploy/hub s3://${{ env.KITGRID_SITE_BUCKET }}/hub --delete

      - name: Sync sites
        run: |
          if [ -d ".kitgrid-cache/deploy/sites" ]; then
            aws s3 sync .kitgrid-cache/deploy/sites s3://${{ env.KITGRID_SITE_BUCKET }}/sites --delete
          else
            echo "No site artifacts to sync"
          fi

      - name: Gather invalidation paths
        id: invalidation
        run: |
          echo "paths=$(pnpm deploy:paths)" >> "$GITHUB_OUTPUT"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.KITGRID_CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths ${{ steps.invalidation.outputs.paths }}
